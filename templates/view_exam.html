<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View & Edit Exam - {{ exam.title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border: 2px solid white;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .nav-link:hover {
            background: white;
            color: #667eea;
        }
        
        .nav-link.primary {
            background: rgba(255,255,255,0.2);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .exam-info {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .exam-title-section h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .exam-status {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-finalized {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-active {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .exam-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .detail-item {
            text-align: center;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .detail-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .detail-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .exam-actions {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .settings-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .section-header {
            background: #f8f9ff;
            padding: 20px 25px;
            border-bottom: 2px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: #333;
            font-weight: 600;
        }
        
        /* Live Candidates Section Styles */
        .live-candidates-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .live-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .live-title {
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .live-count {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .live-candidates-grid {
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .candidate-card {
            background: #f8fffe;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .candidate-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
        }
        
        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .candidate-info h4 {
            color: #059669;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .candidate-id {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .live-indicator {
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .candidate-times {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #d1fae5;
        }
        
        .time-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .time-label {
            color: #6b7280;
            font-weight: 500;
        }
        
        .time-value {
            color: #059669;
            font-weight: 600;
        }
        
        .no-live-candidates {
            padding: 40px;
            text-align: center;
            color: #6b7280;
        }
        
        .no-live-candidates .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .settings-form {
            padding: 25px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .feedback-settings,
        .negative-marking-settings {
            background: #fffbeb;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settings-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #d1d5db;
            border-radius: 15px;
            transition: background 0.3s;
            cursor: pointer;
        }
        
        .toggle-switch.enabled {
            background: #10b981;
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toggle-switch.enabled .toggle-slider {
            transform: translateX(30px);
        }
        
        .questions-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .sections-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 0 25px;
            padding-top: 20px;
        }
        
        .section-tab {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .section-tab:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .section-questions {
            display: none;
            padding: 25px;
        }
        
        .section-questions.active {
            display: block;
        }
        
        .question-card {
            border-bottom: 1px solid #f0f0f0;
            padding: 25px 0;
            transition: background-color 0.3s ease;
        }
        
        .question-card:hover {
            background: #f8f9ff;
        }
        
        .question-card:last-child {
            border-bottom: none;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .question-meta {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .question-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .question-type {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .type-mcq {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .type-short {
            background: #fef3c7;
            color: #92400e;
        }
        
        .type-essay {
            background: #d1fae5;
            color: #065f46;
        }
        
        .question-marks {
            background: #f3f4f6;
            color: #374151;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        

        .section-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .section-badge.custom-section {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .question-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-edit {
            background: #3b82f6;
            color: white;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        .question-text {
            font-size: 1.1rem;
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        /* Question Images Display */
        .question-images-display {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }
        
        .question-image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .question-image-item {
            text-align: center;
            max-width: 300px;
        }
        
        .question-image-item img {
            max-width: 100%;
            height: auto;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .question-image-item img:hover {
            transform: scale(1.05);
        }
        
        .question-image-caption {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }
        
        .options-list {
            margin-left: 20px;
        }
        
        .option-item {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-item.correct {
            background: #d1fae5;
            border: 2px solid #10b981;
        }
        
        .option-item.incorrect {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
        }
        
        .option-label {
            font-weight: 600;
            color: #667eea;
            min-width: 25px;
        }
        
        .expected-answer {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .expected-answer h4 {
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            color: #000;
        }
        
        .options-editor {
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
        }
        
        .option-editor {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .option-editor input {
            flex: 1;
            margin-bottom: 0;
        }
        
        .option-editor input[type="radio"] {
            width: auto;
            flex: none;
        }
        
        /* Image Upload Styles */
        .image-upload-section {
            background: #f0f9ff;
            border: 2px dashed #3b82f6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .image-preview {
            margin-top: 15px;
            max-width: 100%;
        }
        
        .image-preview img {
            max-width: 500px;
            max-height: 300px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            margin: 10px 0;
        }
        
        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .image-item {
            position: relative;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .image-item img {
            max-width: 200px;
            max-height: 150px;
            object-fit: contain;
        }
        
        .image-caption {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }
        
        .delete-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-image-btn:hover {
            background: #dc2626;
        }
        
        .upload-btn {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .upload-btn:hover {
            background: #2563eb;
        }
        
        .upload-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        .file-input-label {
            background: white;
            border: 2px solid #e1e5e9;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input-label:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .upload-progress {
            margin-top: 10px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e1e5e9;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .warning-box {
            background: #fee2e2;
            border: 2px solid #fecaca;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .warning-box h4 {
            color: #dc2626;
            margin-bottom: 10px;
        }
        
        .warning-box p {
            color: #991b1b;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .exam-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .exam-details {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .question-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .question-actions {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
            
            .sections-tabs {
                justify-content: center;
            }
            
            .settings-toggle {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .live-candidates-grid {
                grid-template-columns: 1fr;
            }
            
            .live-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .question-image-container {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üëÅÔ∏è View & Edit Exam</h1>
            <div class="nav-links">
                <button class="nav-link primary" onclick="showAddQuestionModal()">‚ûï Add Question</button>
                <a href="/admin/exam-results/{{ exam.id }}" class="nav-link">üìä View Results</a>
                <a href="/admin" class="nav-link">‚Üê Back to Dashboard</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Exam Information -->
        <div class="exam-info">
            <div class="exam-header">
                <div class="exam-title-section">
                    <h2>{{ exam.title }}</h2>
                    <p style="color: #666; margin-bottom: 15px;">{{ exam.description or 'No description provided' }}</p>
                </div>
                <div class="exam-status">
                    <span class="status-badge status-finalized">‚úÖ Finalized</span>
                    {% if exam.is_active %}
                    <span class="status-badge status-active">üü¢ Active</span>
                    {% else %}
                    <span class="status-badge status-inactive">üî¥ Inactive</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="exam-details">
                <div class="detail-item">
                    <div class="detail-value">{{ exam.department }}</div>
                    <div class="detail-label">Department</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">{{ exam.position }}</div>
                    <div class="detail-label">Position</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">{{ exam.time_limit }} min</div>
                    <div class="detail-label">Time Limit</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">{{ total_questions }}</div>
                    <div class="detail-label">Questions</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value">{{ results_count }}</div>
                    <div class="detail-label">Submissions</div>
                </div>
                <div class="detail-item">
                    <div class="detail-value" id="liveCountDisplay">{{ live_count }}</div>
                    <div class="detail-label">Live Candidates</div>
                </div>
            </div>
        </div>
        
        <!-- Live Candidates Section -->
        <div class="live-candidates-section">
            <div class="live-header">
                <div class="live-title">
                    üî¥ Live Candidates
                    <span class="live-count" id="liveCandidatesCount">{{ live_count }} active</span>
                </div>
                <button class="refresh-btn" onclick="refreshLiveCandidates()">
                    üîÑ Refresh
                </button>
            </div>
            
            <div id="liveCandidatesContainer">
                {% if live_candidates %}
                <div class="live-candidates-grid" id="liveCandidatesGrid">
                    {% for candidate in live_candidates %}
                    <div class="candidate-card">
                        <div class="candidate-header">
                            <div class="candidate-info">
                                <h4>{{ candidate.candidate_name }}</h4>
                                <div class="candidate-id">ID: {{ candidate.candidate_id }}</div>
                            </div>
                            <div class="live-indicator">
                                <span>üî¥</span>
                                <span>LIVE</span>
                            </div>
                        </div>
                        
                        <div class="candidate-times">
                            <div class="time-item">
                                <span class="time-label">Started:</span>
                                <span class="time-value">{{ candidate.started_at.split(' ')[1] if candidate.started_at else 'N/A' }}</span>
                            </div>
                            <div class="time-item">
                                <span class="time-label">Last Activity:</span>
                                <span class="time-value">{{ candidate.last_activity.split(' ')[1] if candidate.last_activity else 'N/A' }}</span>
                            </div>
                            <div class="time-item">
                                <span class="time-label">Duration:</span>
                                <span class="time-value" data-started="{{ candidate.started_at }}">Calculating...</span>
                            </div>
                            <div class="time-item" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #d1fae5;">
                                <button class="btn" style="background: #ef4444; color: white; padding: 6px 12px; font-size: 0.8rem; width: 100%;" 
                                        onclick="endLiveSession('{{ candidate.session_id }}', '{{ candidate.candidate_name }}')">
                                    üî¥ End Session
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-live-candidates">
                    <div class="icon">üò¥</div>
                    <h3>No Live Candidates</h3>
                    <p>No candidates are currently taking this exam.</p>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #9ca3af;">
                        Candidates will appear here when they start the exam and disappear when they submit.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Evaluation Queue Section (Pending/Failed) -->
        <div class="live-candidates-section" id="evaluation-queue-section" style="display: none;">
            <div class="live-header" id="queue-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <div class="live-title">
                    <span id="queue-icon">‚è≥</span> Evaluation Queue
                    <span class="live-count" id="evaluationQueueCount">0 items</span>
                    <span id="queue-paused-badge" style="display: none; background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px;">PAUSED</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="refresh-btn" id="pauseResumeBtn" onclick="toggleEvaluationPause()" style="background: #dc2626;">
                        ‚è∏Ô∏è Pause
                    </button>
                    <button class="refresh-btn" onclick="refreshEvaluationQueue()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>

            <div id="evaluationQueueContainer" style="padding: 20px;">
                <!-- Pending Evaluations -->
                <div id="pending-evaluations-container" style="margin-bottom: 20px; display: none;">
                    <h4 style="margin-bottom: 15px; color: #333;">‚è≥ Pending Evaluations</h4>
                    <div style="overflow-x: auto;">
                        <table class="table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9ff;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">Candidate</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">Submitted</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e1e5e9;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="pending-evaluations-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Failed Evaluations -->
                <div id="failed-evaluations-container" style="display: none;">
                    <h4 style="margin-bottom: 15px; color: #ef4444;">‚ö†Ô∏è Failed Evaluations (Need Manual Review)</h4>
                    <div style="overflow-x: auto;">
                        <table class="table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #fef2f2;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #fecaca;">Candidate</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #fecaca;">Submitted</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #fecaca;">Error</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #fecaca;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="failed-evaluations-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="queue-empty-state" style="text-align: center; padding: 30px; color: #6b7280;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">‚úÖ</div>
                    <p>All evaluations completed. No pending items.</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="exam-actions">
            <h3 style="color: #1e40af; margin-bottom: 10px;">üöÄ Quick Actions</h3>
            <p style="color: #475569; margin-bottom: 15px;">Manage your exam with these quick actions</p>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showExamLink()">üîó Get Exam Link</button>
                <button class="btn btn-warning" onclick="showSettingsModal()">‚öôÔ∏è Edit Settings</button>
                {% if exam.is_active %}
                <button class="btn btn-secondary" onclick="toggleExamStatus(false)">‚è∏Ô∏è Deactivate Exam</button>
                {% else %}
                <button class="btn btn-success" onclick="toggleExamStatus(true)">‚ñ∂Ô∏è Activate Exam</button>
                {% endif %}
            </div>
        </div>
        
        <!-- Exam Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">‚öôÔ∏è Edit Exam Settings</h2>
                    <span class="close" onclick="closeSettingsModal()">&times;</span>
                </div>
                
                <form id="settingsForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="edit_title">üìù Exam Title</label>
                            <input type="text" id="edit_title" value="{{ exam.title }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit_time_limit">‚è∞ Time Limit (minutes)</label>
                            <input type="number" id="edit_time_limit" value="{{ exam.time_limit }}" min="10" max="600" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_description">üìÑ Description</label>
                        <textarea id="edit_description" rows="3">{{ exam.description or '' }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit_instructions">üìã Instructions</label>
                        <textarea id="edit_instructions" rows="4">{{ exam.instructions or '' }}</textarea>
                    </div>
                    
                    <!-- Feedback Settings -->
                    <div class="feedback-settings">
                        <div class="settings-toggle">
                            <div>
                                <h4 style="color: #92400e; margin-bottom: 8px;">üí¨ Candidate Feedback</h4>
                                <p style="color: #92400e; font-size: 0.9rem;">Control whether candidates see detailed feedback after submission</p>
                            </div>
                            <div class="toggle-switch {% if exam.show_feedback %}enabled{% endif %}" id="feedbackToggle" onclick="toggleFeedback()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Negative Marking Settings -->
                    <div class="negative-marking-settings">
                        <h4 style="color: #92400e; margin-bottom: 15px;">‚ûñ Negative Marking Configuration</h4>
                        <div id="negativeMarkingConfig">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Multi-Select MCQ Scoring Mode -->
                    <div class="multi-select-scoring-settings" style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin-top: 20px;">
                        <h4 style="color: #065f46; margin-bottom: 15px;">‚òëÔ∏è Multi-Select MCQ Scoring Mode</h4>
                        <p style="color: #059669; font-size: 0.9rem; margin-bottom: 15px;">Choose how multi-select MCQs should be scored when candidates select some but not all correct answers.</p>

                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <label style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb;">
                                <input type="radio" name="multi_select_scoring_mode" value="partial"
                                       {% if exam.multi_select_scoring_mode == 'partial' or not exam.multi_select_scoring_mode %}checked{% endif %}
                                       style="margin-top: 3px; width: 20px; height: 20px; accent-color: #10b981;">
                                <div>
                                    <strong style="color: #065f46;">Partial Scoring (Recommended)</strong>
                                    <p style="color: #6b7280; font-size: 0.85rem; margin-top: 4px;">
                                        Candidates get partial marks for selecting some correct answers.<br>
                                        Example: If 2 of 3 correct answers are selected = 66% of marks
                                    </p>
                                </div>
                            </label>

                            <label style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb;">
                                <input type="radio" name="multi_select_scoring_mode" value="strict"
                                       {% if exam.multi_select_scoring_mode == 'strict' %}checked{% endif %}
                                       style="margin-top: 3px; width: 20px; height: 20px; accent-color: #10b981;">
                                <div>
                                    <strong style="color: #065f46;">Strict Scoring (All or Nothing)</strong>
                                    <p style="color: #6b7280; font-size: 0.85rem; margin-top: 4px;">
                                        Candidates must select ALL correct answers exactly to get marks.<br>
                                        Example: If 2 of 3 correct answers are selected = 0 marks
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                        <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">üíæ Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Questions Section -->
        <div class="questions-section">
            <div class="section-header">
                <h2 class="section-title">üìù Exam Questions</h2>
                <span style="color: #666;">Click on questions to edit them</span>
            </div>
            
            <!-- Section Tabs -->
            {% if sections %}
            <div class="sections-tabs">
                <button class="section-tab active" onclick="showAllQuestions()">
                    üìã All Questions ({{ total_questions }})
                </button>
                {% for section_name, section_questions in sections.items() %}
                <button class="section-tab" onclick="showSection('{{ section_name }}')">
                    <span>
                        {% if section_name == 'technical' %}‚öôÔ∏è
                        {% elif section_name == 'english' %}üá¨üáß
                        {% elif section_name == 'mathematics' %}üî¢
                        {% elif section_name == 'bengali' %}üáßüá©
                        {% elif section_name == 'general_knowledge' %}üåç
                        {% elif section_name == 'logical_reasoning' %}üß†
                        {% else %}üìù{% endif %}
                    </span>
                    {{ section_name.replace('_', ' ').title() }} ({{ section_questions|length }})
                </button>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- All Questions View -->
            <div id="all-questions" class="section-questions active">
                {% if questions %}
                {% for question in questions %}
                <div class="question-card" data-question-id="{{ question.id }}" data-section="{{ question.section_type }}">
                    <div class="question-header">
                        <div class="question-meta">
                            <div class="question-number">{{ loop.index }}</div>
                            <span class="question-type type-{{ question.type }}">{{ question.type.upper() }}</span>
                            <span class="question-marks">{{ question.marks }} marks</span>
                            {% if question.section_type %}
                            {% set section_config = exam.sections_structure.get(question.section_type, {}) if exam.sections_structure else {} %}
                            {% if section_config.get('is_custom') and section_config.get('display_name') %}
                            <span class="section-badge custom-section">{{ section_config.display_name }}</span>
                            {% else %}
                            <span class="section-badge">{{ question.section_type.replace('_', ' ').title() }}</span>
                            {% endif %}
                            {% endif %}
                        </div>
                        <div class="question-actions">
                            <button class="action-btn btn-edit" onclick="editQuestion('{{ question.id }}')">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteQuestion('{{ question.id }}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    
                    <div class="question-content">
                        <div class="question-text">{{ question.question }}</div>
                        
                        <!-- Display Images if they exist -->
                        {% if question.image_url or (question.images and question.images|length > 0) %}
                        <div class="question-images-display">
                            <div class="question-image-container">
                                {% if question.image_url %}
                                <div class="question-image-item">
                                    <img src="{{ question.image_url }}" alt="Question figure" onclick="window.open('{{ question.image_url }}', '_blank')">
                                    {% if question.image_caption %}
                                    <div class="question-image-caption">{{ question.image_caption }}</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% if question.images %}
                                    {% for image in question.images %}
                                    <div class="question-image-item">
                                        <img src="{{ image.url }}" alt="Question figure" onclick="window.open('{{ image.url }}', '_blank')">
                                        {% if image.caption %}
                                        <div class="question-image-caption">{{ image.caption }}</div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        {% if question.type == 'mcq' %}
                        {% if question.is_multi_select %}
                        <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; padding: 10px 15px; margin-bottom: 15px;">
                            <span style="color: #065f46; font-weight: 600;">‚òëÔ∏è‚òëÔ∏è Multi-Select MCQ - Correct:
                            {% for idx in question.correct_answers %}{{ ['A', 'B', 'C', 'D', 'E', 'F'][idx] }}{% if not loop.last %}, {% endif %}{% endfor %}
                            </span>
                        </div>
                        {% endif %}
                        <div class="options-list">
                            {% for option in question.options %}
                            {% if question.is_multi_select %}
                                {% set is_correct = loop.index0 in question.correct_answers %}
                            {% else %}
                                {% set is_correct = loop.index0 == question.correct_answer %}
                            {% endif %}
                            <div class="option-item {% if is_correct %}correct{% else %}incorrect{% endif %}">
                                <span class="option-label">{{ ['A', 'B', 'C', 'D', 'E', 'F'][loop.index0] }})</span>
                                <span>{{ option }}</span>
                                {% if is_correct %}
                                <span style="margin-left: auto; color: #10b981; font-weight: bold;">‚úì Correct</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="expected-answer">
                            <h4>Expected Answer:</h4>
                            <p>{{ question.expected_answer or 'No expected answer provided' }}</p>
                            {% if question.evaluation_criteria %}
                            <h4 style="margin-top: 15px;">Evaluation Criteria:</h4>
                            <p>{{ question.evaluation_criteria }}</p>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if question.explanation %}
                        <div class="expected-answer" style="background: #fef3c7; border-color: #f59e0b;">
                            <h4 style="color: #92400e;">Explanation:</h4>
                            <p style="color: #92400e;">{{ question.explanation }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div style="padding: 40px; text-align: center; color: #666;">
                    <p>üìù No questions found for this exam.</p>
                    <p>Start by adding questions using the "Add Question" button above.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Section-specific Views -->
            {% for section_name, section_questions in sections.items() %}
            <div id="section-{{ section_name }}" class="section-questions">
                {% for question in section_questions %}
                <div class="question-card" data-question-id="{{ question.id }}" data-section="{{ question.section_type }}">
                    <div class="question-header">
                        <div class="question-meta">
                            <div class="question-number">{{ loop.index }}</div>
                            <span class="question-type type-{{ question.type }}">{{ question.type.upper() }}</span>
                            <span class="question-marks">{{ question.marks }} marks</span>
                        </div>
                        <div class="question-actions">
                            <button class="action-btn btn-edit" onclick="editQuestion('{{ question.id }}')">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteQuestion('{{ question.id }}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    
                    <div class="question-content">
                        <div class="question-text">{{ question.question }}</div>
                        
                        <!-- Display Images if they exist -->
                        {% if question.image_url or (question.images and question.images|length > 0) %}
                        <div class="question-images-display">
                            <div class="question-image-container">
                                {% if question.image_url %}
                                <div class="question-image-item">
                                    <img src="{{ question.image_url }}" alt="Question figure" onclick="window.open('{{ question.image_url }}', '_blank')">
                                    {% if question.image_caption %}
                                    <div class="question-image-caption">{{ question.image_caption }}</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% if question.images %}
                                    {% for image in question.images %}
                                    <div class="question-image-item">
                                        <img src="{{ image.url }}" alt="Question figure" onclick="window.open('{{ image.url }}', '_blank')">
                                        {% if image.caption %}
                                        <div class="question-image-caption">{{ image.caption }}</div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        {% if question.type == 'mcq' %}
                        {% if question.is_multi_select %}
                        <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; padding: 10px 15px; margin-bottom: 15px;">
                            <span style="color: #065f46; font-weight: 600;">‚òëÔ∏è‚òëÔ∏è Multi-Select MCQ - Correct:
                            {% for idx in question.correct_answers %}{{ ['A', 'B', 'C', 'D', 'E', 'F'][idx] }}{% if not loop.last %}, {% endif %}{% endfor %}
                            </span>
                        </div>
                        {% endif %}
                        <div class="options-list">
                            {% for option in question.options %}
                            {% if question.is_multi_select %}
                                {% set is_correct = loop.index0 in question.correct_answers %}
                            {% else %}
                                {% set is_correct = loop.index0 == question.correct_answer %}
                            {% endif %}
                            <div class="option-item {% if is_correct %}correct{% else %}incorrect{% endif %}">
                                <span class="option-label">{{ ['A', 'B', 'C', 'D', 'E', 'F'][loop.index0] }})</span>
                                <span>{{ option }}</span>
                                {% if is_correct %}
                                <span style="margin-left: auto; color: #10b981; font-weight: bold;">‚úì Correct</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="expected-answer">
                            <h4>Expected Answer:</h4>
                            <p>{{ question.expected_answer or 'No expected answer provided' }}</p>
                            {% if question.evaluation_criteria %}
                            <h4 style="margin-top: 15px;">Evaluation Criteria:</h4>
                            <p>{{ question.evaluation_criteria }}</p>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if question.explanation %}
                        <div class="expected-answer" style="background: #fef3c7; border-color: #f59e0b;">
                            <h4 style="color: #92400e;">Explanation:</h4>
                            <p style="color: #92400e;">{{ question.explanation }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        
        <!-- Warning Box for Live Exam Editing -->
        {% if results_count > 0 %}
        <div class="warning-box">
            <h4>‚ö†Ô∏è Live Exam Warning</h4>
            <p><strong>{{ results_count }}</strong> candidates have already taken this exam.</p>
            <p>Changes to questions or settings may affect fairness and consistency of results.</p>
            <p>Consider the impact on already submitted responses before making modifications.</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Edit Question Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Edit Question</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <form id="editQuestionForm">
                <input type="hidden" id="editQuestionId">
                
                <div class="form-group">
                    <label for="editQuestionSection">Section</label>
                    <select id="editQuestionSection">
                        <!-- Sections will be populated dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editQuestionType">Question Type</label>
                    <select id="editQuestionType" onchange="toggleEditOptions()">
                        <option value="mcq">Multiple Choice Question</option>
                        <option value="short">Short Answer Question</option>
                        <option value="essay">Essay Question</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editQuestionText">Question Text</label>
                    <textarea id="editQuestionText" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editQuestionMarks">Marks</label>
                    <input type="number" id="editQuestionMarks" min="1" max="100" required>
                </div>
                
                <!-- IMAGE UPLOAD SECTION FOR EDIT MODAL -->
                <div class="form-group" id="editImageSection">
                    <label>Question Images</label>
                    
                    <!-- Current Images Display -->
                    <div id="editCurrentImages" class="image-gallery"></div>
                    
                    <!-- Image Upload Section -->
                    <div class="image-upload-section">
                        <h4 style="margin-top: 0; color: #333;">üì∑ Add Image to Question</h4>
                        <div class="file-input-wrapper">
                            <label for="editImageFile" class="file-input-label">
                                üìÅ Choose Image File
                            </label>
                            <input type="file" id="editImageFile" class="file-input" accept="image/*" onchange="previewEditImage(event)">
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <input type="text" id="editImageCaption" placeholder="Image caption (optional)" style="width: 100%;">
                        </div>
                        
                        <div id="editImagePreview" class="image-preview" style="display: none;">
                            <img id="editPreviewImg" src="" alt="Preview">
                        </div>
                        
                        <button type="button" class="upload-btn" id="editUploadBtn" onclick="uploadEditImage()" disabled>
                            üì§ Upload Image
                        </button>
                        
                        <div id="editUploadProgress" class="upload-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="editProgressFill"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="editMcqOptions" class="form-group">
                    <!-- Multi-Select Toggle -->
                    <div class="multi-select-toggle" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="editIsMultiSelect" onchange="toggleEditMultiSelect()" style="width: 20px; height: 20px; accent-color: #10b981;">
                            <span style="font-weight: 600; color: #065f46;">Multi-Select MCQ</span>
                        </label>
                        <span style="color: #059669; font-size: 0.85rem;">(Multiple correct answers allowed)</span>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label id="editOptionsLabel" style="margin: 0;">Options (Select the correct answer)</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 0.85rem; color: #666;">Min: 2, Max: 6</span>
                            <button type="button" onclick="addEditOption()" class="btn-add-option" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">+ Add Option</button>
                        </div>
                    </div>

                    <!-- Dynamic Options Container -->
                    <div id="editOptionsContainer" class="options-editor">
                        <!-- Options will be generated dynamically by JavaScript -->
                    </div>
                </div>
                
                <div id="editSubjectiveFields" style="display: none;">
                    <div class="form-group">
                        <label for="editExpectedAnswer">Expected Answer Guidelines</label>
                        <textarea id="editExpectedAnswer" rows="4" placeholder="Provide guidelines for what the answer should contain (key points, structure, etc.)"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editEvaluationCriteria">Evaluation Criteria</label>
                        <textarea id="editEvaluationCriteria" rows="3" placeholder="How should this answer be evaluated? What are the scoring criteria?"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editExplanation">Explanation (Optional)</label>
                    <textarea id="editExplanation" rows="2" placeholder="Explanation for the correct answer or additional context"></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Question Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï Add New Question</h2>
                <span class="close" onclick="closeAddModal()">&times;</span>
            </div>
            
            <form id="addQuestionForm">
                <div class="form-group">
                    <label for="addQuestionSection">Section</label>
                    <select id="addQuestionSection">
                        <!-- Sections will be populated dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="addQuestionType">Question Type</label>
                    <select id="addQuestionType" onchange="toggleAddOptions()">
                        <option value="mcq">Multiple Choice Question</option>
                        <option value="short">Short Answer Question</option>
                        <option value="essay">Essay Question</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="addQuestionText">Question Text</label>
                    <textarea id="addQuestionText" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="addQuestionMarks">Marks</label>
                    <input type="number" id="addQuestionMarks" min="1" max="100" value="5" required>
                </div>
                
                <!-- IMAGE SECTION FOR ADD MODAL -->
                <div class="form-group" id="addImageSection">
                    <label>Question Images</label>
                    
                    <div class="image-upload-section">
                        <h4 style="margin-top: 0; color: #333;">üì∑ Add Image to Question</h4>
                        <p style="color: #666; font-size: 0.9rem;">Note: You can add images after creating the question.</p>
                    </div>
                </div>
                
                <div id="addMcqOptions" class="form-group">
                    <!-- Multi-Select Toggle for Add -->
                    <div class="multi-select-toggle" style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="addIsMultiSelect" onchange="toggleAddMultiSelect()" style="width: 20px; height: 20px; accent-color: #10b981;">
                            <span style="font-weight: 600; color: #065f46;">Multi-Select MCQ</span>
                        </label>
                        <span style="color: #059669; font-size: 0.85rem;">(Multiple correct answers allowed)</span>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label id="addOptionsLabel" style="margin: 0;">Options (Select the correct answer)</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 0.85rem; color: #666;">Min: 2, Max: 6</span>
                            <button type="button" onclick="addAddOption()" class="btn-add-option" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">+ Add Option</button>
                        </div>
                    </div>

                    <!-- Dynamic Options Container for Add -->
                    <div id="addOptionsContainer" class="options-editor">
                        <!-- Options will be generated dynamically by JavaScript -->
                    </div>
                </div>
                
                <div id="addSubjectiveFields" style="display: none;">
                    <div class="form-group">
                        <label for="addExpectedAnswer">Expected Answer Guidelines</label>
                        <textarea id="addExpectedAnswer" rows="4" placeholder="Provide guidelines for what the answer should contain (key points, structure, etc.)"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="addEvaluationCriteria">Evaluation Criteria</label>
                        <textarea id="addEvaluationCriteria" rows="3" placeholder="How should this answer be evaluated? What are the scoring criteria?"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="addExplanation">Explanation (Optional)</label>
                    <textarea id="addExplanation" rows="2" placeholder="Explanation for the correct answer or additional context"></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">‚ûï Add Question</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const examId = '{{ exam.id }}';
        const questions = {{ questions | tojson }};
        const sections = {{ sections | tojson }};
        const examData = {{ exam | tojson }};
        let feedbackEnabled = {{ exam.show_feedback | tojson }};
        let negativeMarkingConfig = {{ exam.negative_marking_config | tojson }};

        // IMAGE UPLOAD VARIABLES
        let currentEditingQuestionId = null;
        let selectedImageFile = null;

        // Section icons for formatting
        const sectionIcons = {
            'technical': '‚öôÔ∏è',
            'english': 'üá¨üáß',
            'mathematics': 'üî¢',
            'bengali': 'üáßüá©',
            'general_knowledge': 'üåç',
            'logical_reasoning': 'üß†'
        };

        function formatSectionName(key) {
            const icon = sectionIcons[key] || 'üìã';
            const name = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            return icon + ' ' + name;
        }

        // Populate section dropdowns on page load
        function populateSectionDropdowns() {
            const sectionKeys = Object.keys(sections);
            const editSelect = document.getElementById('editQuestionSection');
            const addSelect = document.getElementById('addQuestionSection');

            // Clear existing options
            editSelect.innerHTML = '';
            addSelect.innerHTML = '';

            // Add options for each section
            sectionKeys.forEach(key => {
                const option1 = document.createElement('option');
                option1.value = key;
                option1.textContent = formatSectionName(key);
                editSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = key;
                option2.textContent = formatSectionName(key);
                addSelect.appendChild(option2);
            });

            console.log('Section dropdowns populated with:', sectionKeys);
        }

        // Call on page load
        document.addEventListener('DOMContentLoaded', function() {
            populateSectionDropdowns();
            initializeAddOptions(); // Initialize add modal with default 4 options
        });

        // ============================================
        // DYNAMIC MCQ OPTIONS MANAGEMENT
        // ============================================
        const MIN_OPTIONS = 2;
        const MAX_OPTIONS = 6;
        const OPTION_LETTERS = ['A', 'B', 'C', 'D', 'E', 'F'];

        let editOptionCount = 0;
        let addOptionCount = 0;

        // Generate a single option field HTML
        function createOptionFieldHTML(index, value = '', isCorrect = false, isMultiSelect = false, prefix = 'edit') {
            const inputType = isMultiSelect ? 'checkbox' : 'radio';
            const inputName = prefix === 'edit'
                ? (isMultiSelect ? 'editCorrectAnswers' : 'editCorrectAnswer')
                : (isMultiSelect ? 'addCorrectAnswers' : 'addCorrectAnswer');
            const checkedAttr = isCorrect ? 'checked' : '';
            const letter = OPTION_LETTERS[index] || String.fromCharCode(65 + index);

            return `
                <div class="option-editor" data-index="${index}" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <input type="${inputType}" name="${inputName}" value="${index}" ${checkedAttr}
                           style="width: 18px; height: 18px; accent-color: #10b981; cursor: pointer;">
                    <input type="text" class="${prefix}-option-input" data-index="${index}"
                           placeholder="Option ${letter}" value="${value}" required
                           style="flex: 1; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px;">
                    <button type="button" onclick="remove${prefix.charAt(0).toUpperCase() + prefix.slice(1)}Option(${index})"
                            class="btn-remove-option"
                            style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                        ‚úï
                    </button>
                </div>
            `;
        }

        // ============ EDIT MODAL FUNCTIONS ============

        function generateEditOptions(options = [], correctAnswers = [], isMultiSelect = false) {
            const container = document.getElementById('editOptionsContainer');
            container.innerHTML = '';
            editOptionCount = options.length || 4;

            // If no options provided, create default 4 empty options
            if (options.length === 0) {
                options = ['', '', '', ''];
                editOptionCount = 4;
            }

            for (let i = 0; i < options.length; i++) {
                const isCorrect = correctAnswers.includes(i);
                container.innerHTML += createOptionFieldHTML(i, options[i], isCorrect, isMultiSelect, 'edit');
            }

            updateEditRemoveButtons();
        }

        function addEditOption() {
            if (editOptionCount >= MAX_OPTIONS) {
                alert(`Maximum ${MAX_OPTIONS} options allowed`);
                return;
            }

            const container = document.getElementById('editOptionsContainer');
            const isMultiSelect = document.getElementById('editIsMultiSelect').checked;
            container.innerHTML += createOptionFieldHTML(editOptionCount, '', false, isMultiSelect, 'edit');
            editOptionCount++;
            updateEditRemoveButtons();
        }

        function removeEditOption(index) {
            if (editOptionCount <= MIN_OPTIONS) {
                alert(`Minimum ${MIN_OPTIONS} options required`);
                return;
            }

            const container = document.getElementById('editOptionsContainer');
            const optionDiv = container.querySelector(`[data-index="${index}"]`);
            if (optionDiv) {
                optionDiv.remove();
                editOptionCount--;
                reindexEditOptions();
                updateEditRemoveButtons();
            }
        }

        function reindexEditOptions() {
            const container = document.getElementById('editOptionsContainer');
            const options = container.querySelectorAll('.option-editor');
            const isMultiSelect = document.getElementById('editIsMultiSelect').checked;

            options.forEach((opt, idx) => {
                opt.setAttribute('data-index', idx);
                const radio = opt.querySelector('input[type="radio"], input[type="checkbox"]');
                const textInput = opt.querySelector('input[type="text"]');
                const removeBtn = opt.querySelector('.btn-remove-option');

                if (radio) radio.value = idx;
                if (textInput) {
                    textInput.setAttribute('data-index', idx);
                    textInput.placeholder = `Option ${OPTION_LETTERS[idx]}`;
                }
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeEditOption(${idx})`);
                }
            });
        }

        function updateEditRemoveButtons() {
            const container = document.getElementById('editOptionsContainer');
            const buttons = container.querySelectorAll('.btn-remove-option');
            buttons.forEach(btn => {
                btn.disabled = editOptionCount <= MIN_OPTIONS;
                btn.style.opacity = editOptionCount <= MIN_OPTIONS ? '0.5' : '1';
                btn.style.cursor = editOptionCount <= MIN_OPTIONS ? 'not-allowed' : 'pointer';
            });
        }

        function getEditOptionsData() {
            const container = document.getElementById('editOptionsContainer');
            const inputs = container.querySelectorAll('.edit-option-input');
            const options = [];
            inputs.forEach(input => {
                options.push(input.value);
            });
            return options;
        }

        function getEditCorrectAnswers() {
            const isMultiSelect = document.getElementById('editIsMultiSelect').checked;
            const container = document.getElementById('editOptionsContainer');

            if (isMultiSelect) {
                const checked = container.querySelectorAll('input[name="editCorrectAnswers"]:checked');
                return Array.from(checked).map(cb => parseInt(cb.value));
            } else {
                const checked = container.querySelector('input[name="editCorrectAnswer"]:checked');
                return checked ? [parseInt(checked.value)] : [];
            }
        }

        // ============ ADD MODAL FUNCTIONS ============

        function initializeAddOptions() {
            generateAddOptions(['', '', '', ''], [], false);
        }

        function generateAddOptions(options = [], correctAnswers = [], isMultiSelect = false) {
            const container = document.getElementById('addOptionsContainer');
            container.innerHTML = '';
            addOptionCount = options.length || 4;

            if (options.length === 0) {
                options = ['', '', '', ''];
                addOptionCount = 4;
            }

            for (let i = 0; i < options.length; i++) {
                const isCorrect = correctAnswers.includes(i);
                container.innerHTML += createOptionFieldHTML(i, options[i], isCorrect, isMultiSelect, 'add');
            }

            // Select first option by default for single-select
            if (!isMultiSelect && correctAnswers.length === 0) {
                const firstRadio = container.querySelector('input[name="addCorrectAnswer"]');
                if (firstRadio) firstRadio.checked = true;
            }

            updateAddRemoveButtons();
        }

        function addAddOption() {
            if (addOptionCount >= MAX_OPTIONS) {
                alert(`Maximum ${MAX_OPTIONS} options allowed`);
                return;
            }

            const container = document.getElementById('addOptionsContainer');
            const isMultiSelect = document.getElementById('addIsMultiSelect').checked;
            container.innerHTML += createOptionFieldHTML(addOptionCount, '', false, isMultiSelect, 'add');
            addOptionCount++;
            updateAddRemoveButtons();
        }

        function removeAddOption(index) {
            if (addOptionCount <= MIN_OPTIONS) {
                alert(`Minimum ${MIN_OPTIONS} options required`);
                return;
            }

            const container = document.getElementById('addOptionsContainer');
            const optionDiv = container.querySelector(`[data-index="${index}"]`);
            if (optionDiv) {
                optionDiv.remove();
                addOptionCount--;
                reindexAddOptions();
                updateAddRemoveButtons();
            }
        }

        function reindexAddOptions() {
            const container = document.getElementById('addOptionsContainer');
            const options = container.querySelectorAll('.option-editor');

            options.forEach((opt, idx) => {
                opt.setAttribute('data-index', idx);
                const radio = opt.querySelector('input[type="radio"], input[type="checkbox"]');
                const textInput = opt.querySelector('input[type="text"]');
                const removeBtn = opt.querySelector('.btn-remove-option');

                if (radio) radio.value = idx;
                if (textInput) {
                    textInput.setAttribute('data-index', idx);
                    textInput.placeholder = `Option ${OPTION_LETTERS[idx]}`;
                }
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeAddOption(${idx})`);
                }
            });
        }

        function updateAddRemoveButtons() {
            const container = document.getElementById('addOptionsContainer');
            const buttons = container.querySelectorAll('.btn-remove-option');
            buttons.forEach(btn => {
                btn.disabled = addOptionCount <= MIN_OPTIONS;
                btn.style.opacity = addOptionCount <= MIN_OPTIONS ? '0.5' : '1';
                btn.style.cursor = addOptionCount <= MIN_OPTIONS ? 'not-allowed' : 'pointer';
            });
        }

        function getAddOptionsData() {
            const container = document.getElementById('addOptionsContainer');
            const inputs = container.querySelectorAll('.add-option-input');
            const options = [];
            inputs.forEach(input => {
                options.push(input.value);
            });
            return options;
        }

        function getAddCorrectAnswers() {
            const isMultiSelect = document.getElementById('addIsMultiSelect').checked;
            const container = document.getElementById('addOptionsContainer');

            if (isMultiSelect) {
                const checked = container.querySelectorAll('input[name="addCorrectAnswers"]:checked');
                return Array.from(checked).map(cb => parseInt(cb.value));
            } else {
                const checked = container.querySelector('input[name="addCorrectAnswer"]:checked');
                return checked ? [parseInt(checked.value)] : [];
            }
        }

        // Toggle functions for multi-select
        function toggleEditMultiSelect() {
            const isMultiSelect = document.getElementById('editIsMultiSelect').checked;
            const label = document.getElementById('editOptionsLabel');
            label.textContent = isMultiSelect ? 'Options (Select ALL correct answers)' : 'Options (Select the correct answer)';

            // Regenerate options with new input type
            const options = getEditOptionsData();
            generateEditOptions(options, [], isMultiSelect);
        }

        function toggleAddMultiSelect() {
            const isMultiSelect = document.getElementById('addIsMultiSelect').checked;
            const label = document.getElementById('addOptionsLabel');
            label.textContent = isMultiSelect ? 'Options (Select ALL correct answers)' : 'Options (Select the correct answer)';

            // Regenerate options with new input type
            const options = getAddOptionsData();
            generateAddOptions(options, [], isMultiSelect);
        }

        // ============================================
        // END DYNAMIC MCQ OPTIONS MANAGEMENT
        // ============================================

        // Live candidates refresh functionality
        let liveRefreshInterval;
        
        function startLiveRefresh() {
            // Refresh every 30 seconds
            liveRefreshInterval = setInterval(refreshLiveCandidates, 30000);
        }
        
        function stopLiveRefresh() {
            if (liveRefreshInterval) {
                clearInterval(liveRefreshInterval);
            }
        }
        
        async function refreshLiveCandidates() {
            try {
                const response = await fetch(`/api/live-candidates/${examId}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateLiveCandidatesDisplay(data.live_candidates, data.live_count);
                } else {
                    console.error('Failed to fetch live candidates');
                }
            } catch (error) {
                console.error('Error refreshing live candidates:', error);
            }
        }
        
        function updateLiveCandidatesDisplay(liveCandidates, liveCount) {
            // Update count displays
            document.getElementById('liveCountDisplay').textContent = liveCount;
            document.getElementById('liveCandidatesCount').textContent = `${liveCount} active`;
            
            const container = document.getElementById('liveCandidatesContainer');
            
            if (liveCandidates.length === 0) {
                container.innerHTML = `
                    <div class="no-live-candidates">
                        <div class="icon">üò¥</div>
                        <h3>No Live Candidates</h3>
                        <p>No candidates are currently taking this exam.</p>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: #9ca3af;">
                            Candidates will appear here when they start the exam and disappear when they submit.
                        </p>
                    </div>
                `;
            } else {
                const candidatesHTML = liveCandidates.map(candidate => {
                    const startTime = candidate.started_at ? candidate.started_at.split(' ')[1] : 'N/A';
                    const lastActivity = candidate.last_activity ? candidate.last_activity.split(' ')[1] : 'N/A';
                    
                    return `
                        <div class="candidate-card">
                            <div class="candidate-header">
                                <div class="candidate-info">
                                    <h4>${candidate.candidate_name}</h4>
                                    <div class="candidate-id">ID: ${candidate.candidate_id}</div>
                                </div>
                                <div class="live-indicator">
                                    <span>üî¥</span>
                                    <span>LIVE</span>
                                </div>
                            </div>
                            
                            <div class="candidate-times">
                                <div class="time-item">
                                    <span class="time-label">Started:</span>
                                    <span class="time-value">${startTime}</span>
                                </div>
                                <div class="time-item">
                                    <span class="time-label">Last Activity:</span>
                                    <span class="time-value">${lastActivity}</span>
                                </div>
                                <div class="time-item">
                                    <span class="time-label">Duration:</span>
                                    <span class="time-value" data-started="${candidate.started_at}">Calculating...</span>
                                </div>
                                <div class="time-item" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #d1fae5;">
                                    <button class="btn" style="background: #ef4444; color: white; padding: 6px 12px; font-size: 0.8rem; width: 100%;" 
                                            onclick="endLiveSession('${candidate.session_id}', '${candidate.candidate_name}')">
                                        üî¥ End Session
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `<div class="live-candidates-grid">${candidatesHTML}</div>`;
                
                // Update durations for new elements
                updateDurations();
            }
        }
        
        function updateDurations() {
            const durationElements = document.querySelectorAll('[data-started]');
            durationElements.forEach(element => {
                const startedAt = element.getAttribute('data-started');
                if (startedAt && startedAt !== 'None') {
                    const duration = calculateDuration(startedAt);
                    element.textContent = duration;
                }
            });
        }
        
        function calculateDuration(startedAt) {
            try {
                // Parse Bangladesh time (already converted from UTC)
                const start = new Date(startedAt);
                const now = new Date();
                
                // Get current Bangladesh time
                const bdTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Dhaka"}));
                
                const diffMs = bdTime - start;
                const diffMins = Math.floor(diffMs / 60000);
                const hours = Math.floor(diffMins / 60);
                const minutes = diffMins % 60;
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                } else {
                    return `${minutes}m`;
                }
            } catch (error) {
                return 'N/A';
            }
        }
        
        // Section navigation functions
        function showAllQuestions() {
            document.querySelectorAll('.section-questions').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('all-questions').classList.add('active');
            document.querySelectorAll('.section-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector('.section-tab').classList.add('active');
        }
        
        function showSection(sectionName) {
            document.querySelectorAll('.section-questions').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`section-${sectionName}`).classList.add('active');
            document.querySelectorAll('.section-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="showSection('${sectionName}')"]`).classList.add('active');
        }
        
        // Question editing functions
        function editQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (!question) {
                console.error('Question not found:', questionId);
                alert('Question not found!');
                return;
            }
            console.log('Editing question:', question);

            // SET CURRENT EDITING QUESTION ID FOR IMAGE UPLOAD
            currentEditingQuestionId = questionId;

            document.getElementById('editQuestionId').value = questionId;
            document.getElementById('editQuestionSection').value = question.section_type || 'technical';
            document.getElementById('editQuestionType').value = question.type;
            document.getElementById('editQuestionText').value = question.question;
            document.getElementById('editQuestionMarks').value = question.marks;
            document.getElementById('editExplanation').value = question.explanation || '';

            if (question.type === 'mcq') {
                const isMultiSelect = question.is_multi_select === true;
                console.log('Is multi-select:', isMultiSelect, 'Options count:', question.options?.length);

                // Set the multi-select toggle checkbox
                document.getElementById('editIsMultiSelect').checked = isMultiSelect;

                // Update label text
                const label = document.getElementById('editOptionsLabel');
                label.textContent = isMultiSelect ? 'Options (Select ALL correct answers)' : 'Options (Select the correct answer)';

                // Get correct answers array
                let correctAnswers = [];
                if (isMultiSelect && question.correct_answers) {
                    correctAnswers = Array.isArray(question.correct_answers) ? question.correct_answers : [];
                } else if (question.correct_answer !== null && question.correct_answer !== undefined) {
                    correctAnswers = [question.correct_answer];
                }

                // Generate dynamic option fields
                generateEditOptions(question.options || [], correctAnswers, isMultiSelect);
            } else {
                document.getElementById('editExpectedAnswer').value = question.expected_answer || '';
                document.getElementById('editEvaluationCriteria').value = question.evaluation_criteria || '';

                // Reset multi-select to default state for non-MCQ
                document.getElementById('editIsMultiSelect').checked = false;
                generateEditOptions([], [], false);
            }

            toggleEditOptions();

            // LOAD IMAGES FOR THIS QUESTION
            loadQuestionImages(questionId);

            document.getElementById('editModal').style.display = 'block';
        }

        // IMAGE FUNCTIONS
        async function loadQuestionImages(questionId) {
            try {
                const response = await fetch(`/api/question-images/${questionId}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayQuestionImages(data.images);
                }
            } catch (error) {
                console.error('Error loading question images:', error);
            }
        }
        
        function displayQuestionImages(images) {
            const container = document.getElementById('editCurrentImages');
            container.innerHTML = '';
            
            if (!images || images.length === 0) {
                container.innerHTML = '<p style="color: #666;">No images attached to this question.</p>';
                return;
            }
            
            images.forEach(image => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <button class="delete-image-btn" onclick="deleteQuestionImage('${image.id}')" title="Delete image">√ó</button>
                    <img src="${image.url}" alt="${image.caption || 'Question image'}">
                    ${image.caption ? `<div class="image-caption">${image.caption}</div>` : ''}
                `;
                container.appendChild(imageItem);
            });
        }
        
        function previewEditImage(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file size
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ùå File size exceeds 5MB limit');
                    event.target.value = '';
                    return;
                }
                
                // Validate file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
                if (!allowedTypes.includes(file.type)) {
                    alert('‚ùå Invalid file type. Please select an image file.');
                    event.target.value = '';
                    return;
                }
                
                selectedImageFile = file;
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    document.getElementById('editPreviewImg').src = e.target.result;
                    document.getElementById('editImagePreview').style.display = 'block';
                    document.getElementById('editUploadBtn').disabled = false;
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        async function uploadEditImage() {
            if (!selectedImageFile || !currentEditingQuestionId) {
                alert('‚ùå Please select an image first');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', selectedImageFile);
            
            const caption = document.getElementById('editImageCaption').value.trim();
            if (caption) {
                formData.append('caption', caption);
            }
            
            // Show progress
            document.getElementById('editUploadProgress').style.display = 'block';
            document.getElementById('editUploadBtn').disabled = true;
            
            try {
                const response = await fetch(`/api/upload-question-image/${currentEditingQuestionId}`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Image uploaded successfully!');
                    
                    // Reload images
                    await loadQuestionImages(currentEditingQuestionId);
                    
                    // Reset form
                    document.getElementById('editImageFile').value = '';
                    document.getElementById('editImageCaption').value = '';
                    document.getElementById('editImagePreview').style.display = 'none';
                    document.getElementById('editUploadBtn').disabled = true;
                    selectedImageFile = null;
                    
                    // Update progress bar
                    document.getElementById('editProgressFill').style.width = '100%';
                    setTimeout(() => {
                        document.getElementById('editUploadProgress').style.display = 'none';
                        document.getElementById('editProgressFill').style.width = '0%';
                    }, 1000);
                } else {
                    alert('‚ùå Error uploading image: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error uploading image: ' + error.message);
            } finally {
                document.getElementById('editUploadBtn').disabled = false;
            }
        }
        
        async function deleteQuestionImage(imageId) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/delete-question-image/${imageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Image deleted successfully!');
                    // Reload images
                    await loadQuestionImages(currentEditingQuestionId);
                } else {
                    alert('‚ùå Error deleting image: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error deleting image: ' + error.message);
            }
        }
        
        function toggleEditOptions() {
            const type = document.getElementById('editQuestionType').value;
            const mcqOptions = document.getElementById('editMcqOptions');
            const subjectiveFields = document.getElementById('editSubjectiveFields');
            
            if (type === 'mcq') {
                mcqOptions.style.display = 'block';
                subjectiveFields.style.display = 'none';
                document.querySelectorAll('#editMcqOptions input[type="text"]').forEach(input => {
                    input.required = true;
                });
                document.querySelectorAll('#editSubjectiveFields textarea').forEach(textarea => {
                    textarea.required = false;
                });
            } else {
                mcqOptions.style.display = 'none';
                subjectiveFields.style.display = 'block';
                document.querySelectorAll('#editMcqOptions input[type="text"]').forEach(input => {
                    input.required = false;
                });
                document.querySelectorAll('#editSubjectiveFields textarea').forEach(textarea => {
                    textarea.required = false;
                });
            }
        }
        
        function toggleAddOptions() {
            const type = document.getElementById('addQuestionType').value;
            const mcqOptions = document.getElementById('addMcqOptions');
            const subjectiveFields = document.getElementById('addSubjectiveFields');
            
            if (type === 'mcq') {
                mcqOptions.style.display = 'block';
                subjectiveFields.style.display = 'none';
                document.querySelectorAll('#addMcqOptions input[type="text"]').forEach(input => {
                    input.required = true;
                });
                document.querySelectorAll('#addSubjectiveFields textarea').forEach(textarea => {
                    textarea.required = false;
                });
            } else {
                mcqOptions.style.display = 'none';
                subjectiveFields.style.display = 'block';
                document.querySelectorAll('#addMcqOptions input[type="text"]').forEach(input => {
                    input.required = false;
                });
                document.querySelectorAll('#addSubjectiveFields textarea').forEach(textarea => {
                    textarea.required = false;
                });
            }
        }
        
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            // RESET IMAGE UPLOAD FIELDS
            currentEditingQuestionId = null;
            selectedImageFile = null;
            document.getElementById('editImageFile').value = '';
            document.getElementById('editImageCaption').value = '';
            document.getElementById('editImagePreview').style.display = 'none';
            document.getElementById('editUploadBtn').disabled = true;
            document.getElementById('editCurrentImages').innerHTML = '';

            // RESET MULTI-SELECT STATE TO DEFAULT (single-select) with dynamic options
            document.getElementById('editIsMultiSelect').checked = false;
            document.getElementById('editOptionsLabel').textContent = 'Options (Select the correct answer)';
            generateEditOptions(['', '', '', ''], [], false); // Reset to 4 empty options
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('addQuestionForm').reset();

            // Reset add modal options to default
            document.getElementById('addIsMultiSelect').checked = false;
            document.getElementById('addOptionsLabel').textContent = 'Options (Select the correct answer)';
            initializeAddOptions(); // Reset to 4 empty options
        }

        function showAddQuestionModal() {
            document.getElementById('addModal').style.display = 'block';
            toggleAddOptions();
            initializeAddOptions(); // Ensure options are initialized
        }
        
        // Settings modal functions
        function showSettingsModal() {
            populateNegativeMarkingConfig();
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function toggleFeedback() {
            const toggle = document.getElementById('feedbackToggle');
            feedbackEnabled = !feedbackEnabled;
            
            if (feedbackEnabled) {
                toggle.classList.add('enabled');
            } else {
                toggle.classList.remove('enabled');
            }
        }
        
        function populateNegativeMarkingConfig() {
            const container = document.getElementById('negativeMarkingConfig');
            const sections = ['technical', 'english', 'mathematics', 'bengali', 'general_knowledge', 'logical_reasoning'];
            const sectionIcons = {
                'technical': '‚öôÔ∏è',
                'english': 'üá¨üáß',
                'mathematics': 'üî¢',
                'bengali': 'üáßüá©',
                'general_knowledge': 'üåç',
                'logical_reasoning': 'üß†'
            };
            
            let html = '';
            sections.forEach(section => {
                const config = negativeMarkingConfig[section] || { enabled: false, mcq_negative_marks: 0.5 };
                html += `
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; border: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${sectionIcons[section]} ${section.replace('_', ' ').toUpperCase()}</strong>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label>
                                    <input type="checkbox" id="negative_${section}" ${config.enabled ? 'checked' : ''}
                                           onchange="updateNegativeMarking('${section}')">
                                    Enable negative marking
                                </label>
                                <input type="number" id="negative_marks_${section}" value="${config.mcq_negative_marks}"
                                       step="0.25" min="0" max="5" style="width: 80px; padding: 5px;"
                                       ${!config.enabled ? 'disabled' : ''}>
                                <span>marks</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function updateNegativeMarking(section) {
            const checkbox = document.getElementById(`negative_${section}`);
            const input = document.getElementById(`negative_marks_${section}`);
            
            input.disabled = !checkbox.checked;
            
            if (!negativeMarkingConfig[section]) {
                negativeMarkingConfig[section] = {};
            }
            negativeMarkingConfig[section].enabled = checkbox.checked;
            negativeMarkingConfig[section].mcq_negative_marks = parseFloat(input.value) || 0;
        }
        
        // Form submission handlers
        document.getElementById('editQuestionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const questionId = document.getElementById('editQuestionId').value;
            const type = document.getElementById('editQuestionType').value;
            
            const questionData = {
                type: type,
                section_type: document.getElementById('editQuestionSection').value,
                question: document.getElementById('editQuestionText').value,
                marks: parseInt(document.getElementById('editQuestionMarks').value),
                explanation: document.getElementById('editExplanation').value
            };
            
            if (type === 'mcq') {
                // Handle multi-select MCQ with dynamic options
                const isMultiSelect = document.getElementById('editIsMultiSelect').checked;
                questionData.is_multi_select = isMultiSelect;

                // Get options dynamically
                questionData.options = getEditOptionsData();

                // Validate minimum options
                if (questionData.options.length < MIN_OPTIONS) {
                    alert(`Please add at least ${MIN_OPTIONS} options`);
                    return;
                }

                // Check for empty options
                const emptyOptions = questionData.options.filter(opt => !opt.trim());
                if (emptyOptions.length > 0) {
                    alert('Please fill in all option fields');
                    return;
                }

                // Get correct answers dynamically
                const correctAnswers = getEditCorrectAnswers();

                if (isMultiSelect) {
                    if (correctAnswers.length < 2) {
                        alert('Please select at least 2 correct answers for multi-select MCQ');
                        return;
                    }
                    questionData.correct_answers = correctAnswers;
                    questionData.correct_answer = correctAnswers[0]; // Keep for backward compatibility
                } else {
                    if (correctAnswers.length === 0) {
                        alert('Please select the correct answer');
                        return;
                    }
                    questionData.correct_answer = correctAnswers[0];
                    questionData.correct_answers = null;
                }
            } else {
                questionData.expected_answer = document.getElementById('editExpectedAnswer').value;
                questionData.evaluation_criteria = document.getElementById('editEvaluationCriteria').value;
            }

            try {
                const response = await fetch(`/api/update-question/${questionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(questionData)
                });
                
                if (response.ok) {
                    alert('‚úÖ Question updated successfully!');
                    location.reload();
                } else {
                    throw new Error('Failed to update question');
                }
            } catch (error) {
                alert('‚ùå Error updating question: ' + error.message);
            }
        });
        
        document.getElementById('addQuestionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('addQuestionType').value;
            
            const questionData = {
                type: type,
                section_type: document.getElementById('addQuestionSection').value,
                question: document.getElementById('addQuestionText').value,
                marks: parseInt(document.getElementById('addQuestionMarks').value),
                explanation: document.getElementById('addExplanation').value
            };
            
            if (type === 'mcq') {
                // Handle multi-select MCQ with dynamic options
                const isMultiSelect = document.getElementById('addIsMultiSelect').checked;
                questionData.is_multi_select = isMultiSelect;

                // Get options dynamically
                questionData.options = getAddOptionsData();

                // Validate minimum options
                if (questionData.options.length < MIN_OPTIONS) {
                    alert(`Please add at least ${MIN_OPTIONS} options`);
                    return;
                }

                // Check for empty options
                const emptyOptions = questionData.options.filter(opt => !opt.trim());
                if (emptyOptions.length > 0) {
                    alert('Please fill in all option fields');
                    return;
                }

                // Get correct answers dynamically
                const correctAnswers = getAddCorrectAnswers();

                if (isMultiSelect) {
                    if (correctAnswers.length < 2) {
                        alert('Please select at least 2 correct answers for multi-select MCQ');
                        return;
                    }
                    questionData.correct_answers = correctAnswers;
                    questionData.correct_answer = correctAnswers[0]; // Keep for backward compatibility
                } else {
                    if (correctAnswers.length === 0) {
                        alert('Please select the correct answer');
                        return;
                    }
                    questionData.correct_answer = correctAnswers[0];
                    questionData.correct_answers = null;
                }
            } else {
                questionData.expected_answer = document.getElementById('addExpectedAnswer').value;
                questionData.evaluation_criteria = document.getElementById('addEvaluationCriteria').value;
            }

            try {
                const response = await fetch(`/api/add-question/${examId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(questionData)
                });
                
                if (response.ok) {
                    alert('‚úÖ Question added successfully!');
                    location.reload();
                } else {
                    throw new Error('Failed to add question');
                }
            } catch (error) {
                alert('‚ùå Error adding question: ' + error.message);
            }
        });
        
        document.getElementById('settingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Collect negative marking config
            const sections = ['technical', 'english', 'mathematics', 'bengali', 'general_knowledge', 'logical_reasoning'];
            sections.forEach(section => {
                const checkbox = document.getElementById(`negative_${section}`);
                const input = document.getElementById(`negative_marks_${section}`);
                
                if (checkbox && input) {
                    if (!negativeMarkingConfig[section]) {
                        negativeMarkingConfig[section] = {};
                    }
                    negativeMarkingConfig[section].enabled = checkbox.checked;
                    negativeMarkingConfig[section].mcq_negative_marks = parseFloat(input.value) || 0;
                }
            });
            
            // Get multi-select scoring mode
            const multiSelectScoringMode = document.querySelector('input[name="multi_select_scoring_mode"]:checked')?.value || 'partial';

            const settingsData = {
                title: document.getElementById('edit_title').value,
                description: document.getElementById('edit_description').value,
                time_limit: parseInt(document.getElementById('edit_time_limit').value),
                instructions: document.getElementById('edit_instructions').value,
                show_feedback: feedbackEnabled,
                negative_marking_config: negativeMarkingConfig,
                multi_select_scoring_mode: multiSelectScoringMode
            };
            
            try {
                const response = await fetch(`/api/update-exam-settings/${examId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(settingsData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Exam settings updated successfully!');
                    location.reload();
                } else {
                    throw new Error(result.error || 'Failed to update settings');
                }
            } catch (error) {
                alert('‚ùå Error updating settings: ' + error.message);
            }
        });
        
        // Other functions
        async function deleteQuestion(questionId) {
            if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/delete-question/${questionId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        alert('‚úÖ Question deleted successfully!');
                        const questionCards = document.querySelectorAll(`[data-question-id="${questionId}"]`);
                        questionCards.forEach(card => {
                            card.style.transition = 'opacity 0.3s ease';
                            card.style.opacity = '0';
                            setTimeout(() => card.remove(), 300);
                        });
                    } else {
                        throw new Error('Failed to delete question');
                    }
                } catch (error) {
                    alert('‚ùå Error deleting question: ' + error.message);
                }
            }
        }
        
        async function showExamLink() {
            if (examData.exam_link) {
                const fullLink = `${window.location.origin}/exam/${examData.exam_link}`;
                
                try {
                    await navigator.clipboard.writeText(fullLink);
                    alert(`üìã Exam link copied to clipboard!\n\n${fullLink}\n\nShare this link with candidates.`);
                } catch (err) {
                    alert(`üìã Exam Link:\n\n${fullLink}\n\nCopy this link and share it with candidates.`);
                }
            } else {
                alert('‚ùå Exam link not available. Please ensure the exam is finalized.');
            }
        }
        
        async function toggleExamStatus(isActive) {
            const action = isActive ? 'activate' : 'deactivate';
            const actionPast = isActive ? 'activated' : 'deactivated';
            
            if (confirm(`Are you sure you want to ${action} this exam?\n\n${isActive ? 'Candidates will be able to access the exam.' : 'The exam link will become inaccessible to candidates.'}`)) {
                try {
                    const response = await fetch(`/api/toggle-exam-status/${examId}`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_active: isActive })
                    });
                    
                    if (response.ok) {
                        alert(`‚úÖ Exam ${actionPast} successfully!`);
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to update exam status');
                    }
                } catch (error) {
                    alert('‚ùå Error updating exam status: ' + error.message);
                }
            }
        }
        
        // Add function to manually end live session
        async function endLiveSession(sessionId, candidateName) {
            if (confirm(`Are you sure you want to end the live session for ${candidateName}?\n\nThis will remove them from the live candidates list.`)) {
                try {
                    const response = await fetch(`/api/end-live-session/${sessionId}`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert(`‚úÖ Live session ended successfully for ${candidateName}`);
                        refreshLiveCandidates();
                    } else {
                        alert(`‚ùå Failed to end session: ${result.error}`);
                    }
                } catch (error) {
                    alert(`‚ùå Error ending session: ${error.message}`);
                }
            }
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const addModal = document.getElementById('addModal');
            const settingsModal = document.getElementById('settingsModal');
            
            if (event.target === editModal) {
                closeModal();
            }
            if (event.target === addModal) {
                closeAddModal();
            }
            if (event.target === settingsModal) {
                closeSettingsModal();
            }
        }
        
        // ============================================
        // EVALUATION QUEUE FUNCTIONS
        // ============================================
        let queueRefreshInterval;

        async function refreshEvaluationQueue() {
            try {
                const response = await fetch(`/api/exam-queue-stats/${examId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch queue stats');
                }

                const data = await response.json();

                if (data.success) {
                    updateEvaluationQueueUI(data);
                } else {
                    console.error('Error fetching queue stats:', data.error);
                }
            } catch (error) {
                console.error('Error refreshing evaluation queue:', error);
            }
        }

        // Track current pause state
        let isEvaluationPaused = false;

        function updateEvaluationQueueUI(data) {
            const pending = data.pending_evaluations || [];
            const failed = data.failed_evaluations || [];
            const totalCount = pending.length + failed.length;
            isEvaluationPaused = data.evaluation_paused || false;

            const queueSection = document.getElementById('evaluation-queue-section');
            const queueCountEl = document.getElementById('evaluationQueueCount');
            const queueIcon = document.getElementById('queue-icon');
            const queueHeader = document.getElementById('queue-header');
            const pausedBadge = document.getElementById('queue-paused-badge');
            const pauseResumeBtn = document.getElementById('pauseResumeBtn');

            // Update pause/resume button and header based on state
            if (isEvaluationPaused) {
                pauseResumeBtn.innerHTML = '‚ñ∂Ô∏è Resume';
                pauseResumeBtn.style.background = '#10b981';
                pausedBadge.style.display = 'inline';
                queueHeader.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
            } else {
                pauseResumeBtn.innerHTML = '‚è∏Ô∏è Pause';
                pauseResumeBtn.style.background = '#dc2626';
                pausedBadge.style.display = 'none';
                queueHeader.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            }

            // Show/hide the section based on whether there are items
            if (totalCount > 0) {
                queueSection.style.display = 'block';
                queueCountEl.textContent = `${totalCount} item${totalCount > 1 ? 's' : ''}`;

                // Update icon based on status
                if (isEvaluationPaused) {
                    queueIcon.textContent = '‚è∏Ô∏è';
                } else if (pending.some(item => item.evaluation_status === 'processing')) {
                    queueIcon.textContent = '‚öôÔ∏è';
                } else if (pending.length > 0) {
                    queueIcon.textContent = '‚è≥';
                } else {
                    queueIcon.textContent = '‚ö†Ô∏è';
                }
            } else {
                queueSection.style.display = 'none';
                return;
            }

            // Update pending evaluations table
            const pendingContainer = document.getElementById('pending-evaluations-container');
            const pendingBody = document.getElementById('pending-evaluations-body');
            const emptyState = document.getElementById('queue-empty-state');

            if (pending.length > 0) {
                pendingContainer.style.display = 'block';
                emptyState.style.display = 'none';
                pendingBody.innerHTML = pending.map(item => `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 12px;">
                            <strong>${item.candidate_name}</strong><br>
                            <small style="color: #666;">${item.candidate_id}</small>
                        </td>
                        <td style="padding: 12px;">${item.submitted_at ? item.submitted_at.split(' ')[0] + ' ' + (item.submitted_at.split(' ')[1] || '') : 'N/A'}</td>
                        <td style="padding: 12px;">
                            <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
                                         background: ${item.evaluation_status === 'processing' ? '#dbeafe' : '#fef3c7'};
                                         color: ${item.evaluation_status === 'processing' ? '#1e40af' : '#92400e'};">
                                ${item.evaluation_status === 'processing' ? '‚öôÔ∏è Processing' : '‚è≥ Pending'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } else {
                pendingContainer.style.display = 'none';
            }

            // Update failed evaluations table
            const failedContainer = document.getElementById('failed-evaluations-container');
            const failedBody = document.getElementById('failed-evaluations-body');

            if (failed.length > 0) {
                failedContainer.style.display = 'block';
                emptyState.style.display = 'none';
                failedBody.innerHTML = failed.map(item => `
                    <tr style="border-bottom: 1px solid #fecaca;">
                        <td style="padding: 12px;">
                            <strong>${item.candidate_name}</strong><br>
                            <small style="color: #666;">${item.candidate_id}</small>
                        </td>
                        <td style="padding: 12px;">${item.submitted_at ? item.submitted_at.split(' ')[0] : 'N/A'}</td>
                        <td style="padding: 12px; color: #ef4444; font-size: 0.85rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                            ${item.evaluation_error || 'Unknown error'}
                        </td>
                        <td style="padding: 12px;">
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn" style="background: #f59e0b; color: white; padding: 6px 12px; font-size: 0.8rem; border: none; border-radius: 5px; cursor: pointer;"
                                        onclick="retryEvaluation('${item.result_id}')" title="Retry automatic evaluation">
                                    üîÑ Retry
                                </button>
                                <a href="/admin/manual-evaluate/${item.result_id}" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; font-size: 0.8rem; text-decoration: none; border-radius: 5px;"
                                   title="Manually grade this submission">
                                    ‚úèÔ∏è Manual
                                </a>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } else {
                failedContainer.style.display = 'none';
            }

            // Show empty state if nothing
            if (pending.length === 0 && failed.length === 0) {
                emptyState.style.display = 'block';
            }
        }

        async function retryEvaluation(resultId) {
            if (!confirm('Are you sure you want to retry automatic evaluation for this submission?')) {
                return;
            }

            try {
                const response = await fetch(`/api/retry-evaluation/${resultId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Evaluation has been re-queued successfully!');
                    refreshEvaluationQueue();
                } else {
                    alert('Error: ' + (data.error || 'Failed to retry evaluation'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function toggleEvaluationPause() {
            const action = isEvaluationPaused ? 'resume' : 'pause';
            const confirmMsg = isEvaluationPaused
                ? 'Resume evaluation processing for this exam? Pending evaluations will start being processed.'
                : 'Pause evaluation processing for this exam? Pending evaluations will wait until you resume.';

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                const endpoint = isEvaluationPaused
                    ? `/api/exam-evaluation-resume/${examId}`
                    : `/api/exam-evaluation-pause/${examId}`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    refreshEvaluationQueue();
                } else {
                    alert('Error: ' + (data.error || `Failed to ${action} evaluation`));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function startQueueRefresh() {
            queueRefreshInterval = setInterval(refreshEvaluationQueue, 15000); // Refresh every 15 seconds
        }

        function stopQueueRefresh() {
            if (queueRefreshInterval) {
                clearInterval(queueRefreshInterval);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ View exam page loaded with image support');
            console.log('Exam:', examData);
            console.log('Questions:', questions.length);
            console.log('Results count:', {{ results_count }});
            console.log('Live candidates:', {{ live_count }});

            // Start live refresh
            startLiveRefresh();

            // Start queue refresh
            refreshEvaluationQueue();
            startQueueRefresh();

            // Update durations initially
            updateDurations();

            // Update durations every minute
            setInterval(updateDurations, 60000);
        });

        // Stop live refresh when page is unloaded
        window.addEventListener('beforeunload', function() {
            stopLiveRefresh();
            stopQueueRefresh();
        });

        // Handle visibility change to pause/resume refresh
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopLiveRefresh();
                stopQueueRefresh();
            } else {
                startLiveRefresh();
                startQueueRefresh();
                refreshLiveCandidates();
                refreshEvaluationQueue();
            }
        });
    </script>
</body>
</html>